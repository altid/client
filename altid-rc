#!/bin/rc
# Requires 9fs

fn close{
	@{echo kill>/proc/$catkill/ctl}
}

fn shutdown{
	unmount /n/$1
	rm /srv/$1
	close
	exit
}

fn sighup{
	shutdown $1
}

fn sigint{
	shutdown $1
}

if(! test -e /n/$1/ctrl)
	9fs $1

if (test -e /n/$1/feed){
	tail -f /n/$1/feed | while(line=`{read}){ echo $line | sed 's/%\[(.*)\]\(.*\)/\1/;s/\\//g'} &
	catkill=$apid
}
if not
	cat /n/$1/buffer


# We want a timer running every 1 minute firing off a scrub of /n/$1/tabs
# From that we'll output a line showing messages for any blue/red channel
fn updates{
	while (){
		sleep 60
		grep -e red -e blue /n/$1/tabs | sed 's/%\[(.*)\]\(.*\)/\1/;s/\\//g' >[2]/dev/null

	}
}

updates $1 &

while(talk=`{read}){
	switch($talk(1)){
	case /quit
		unmount /n/$1
		rm /srv/$1
		close
		exit
	case /close
		if (~ $talk(2) '')
			echo must specify a channel
		if not
			echo close $talk >>/n/$1/ctrl
	case /open
		if (~ $talk(2) '')
			echo must specify a channel to join
		if not
			echo open $talk(2) >>/n/$1/ctrl
	case /tabs
		cat /n/$1/tabs | sed 's/%\[(.*)\]\(.*\)/\1/;s/\\//g'
	case /title
		cat /n/$1/title | sed 's/%\[(.*)\]\(.*\)/\1/;s/\\//g'
	case /buffer
		if (~ $talk(2) '')
			echo must specify a buffer
		if not {
			echo buffer $talk(2) >>/n/$1/ctrl 
			@{echo kill>/proc/$catkill/ctl}
			if (test -e /n/$1/feed){
				tail -f /n/$1/feed | while(line=`{read}){ echo $line |sed 's/%\[(.*)\]\(.*\)/\1/;s/\\//g'} &
				catkill=$apid
			}
			if not
				cat /n/$1/buffer
		}
	case *
		if(! ~ $talk ''){
			echo $talk >>/n/$1/input
		}
	}
}
